<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>記憶の彼方 - Pastel Edition</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #A3D8FF; 
            --bg-base: #FFFBFA;
            --tab-1: #FFDDE2; --tab-2: #FFECC7; --tab-3: #FEFFD6;
            --tab-4: #D8F8E1; --tab-5: #D6EFFF; --tab-6: #EADCFB;
            --text-main: #333;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; margin: 0; padding: 0; width: 100%; overflow: hidden; position: fixed; }
        body { font-family: 'Noto Sans JP', sans-serif; background-color: var(--bg-base); color: var(--text-main); }

        #fixed-bg-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-repeat: no-repeat; background-position: center; background-size: cover; display: none; pointer-events: none; }

        .fixed-top { position: fixed; top: 0; left: 0; right: 0; background: rgba(255, 255, 255, 0.94); backdrop-filter: blur(10px); z-index: 1000; border-bottom: 2px solid #EEE; padding-top: env(safe-area-inset-top); }
        .header-main { display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; height: 64px; }
        .app-title { font-size: 22px; font-weight: 800; color: #333; margin: 0; }
        .header-icons { display: flex; gap: 10px; }
        .icon-btn { background: #fff; border: 1px solid #DDD; border-radius: 12px; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; font-size: 18px; color: #666; cursor: pointer; }

        .tab-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; padding: 4px 10px 10px; }
        .tab { height: 48px; border-radius: 12px; font-size: 0.85rem; border: 2px solid transparent; font-weight: bold; display: flex; align-items: center; justify-content: center; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
        .tab:nth-child(1) { background: var(--tab-1); }
        .tab:nth-child(2) { background: var(--tab-2); }
        .tab:nth-child(3) { background: var(--tab-3); }
        .tab:nth-child(4) { background: var(--tab-4); }
        .tab:nth-child(5) { background: var(--tab-5); }
        .tab:nth-child(6) { background: var(--tab-6); }
        .tab.active { border-color: rgba(0,0,0,0.15); filter: brightness(0.95); transform: translateY(1px); }

        #main-scroll-area { position: absolute; top: 0; left: 0; right: 0; bottom: 0; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 10px; }

        /* メモアイテム: 透明度 0.4 の設定 */
        .memo-item { 
            display: flex; 
            align-items: center; 
            margin-bottom: 10px; 
            padding: 12px; 
            border-radius: 16px; 
            background: rgba(255, 255, 255, 0.4) !important; /* 透過率 0.4 */
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
            backdrop-filter: none !important; 
            -webkit-backdrop-filter: none !important;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        /* 文字の視認性を高める影の追加 */
        .memo-body { 
            flex: 1; font-size: 0.95rem; color: #111; margin: 0 12px; 
            white-space: pre-wrap; word-break: break-all; 
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; 
            font-weight: 700;
            /* 文字の背景に薄い光彩を入れて読みやすくする */
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.9), 0 0 4px rgba(255, 255, 255, 0.9);
        }
        .date-text { 
            font-size: 0.7rem; color: #444; min-width: 70px; flex-shrink: 0; 
            font-family: monospace; font-weight: bold;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.9);
        }

        .input-container { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255, 255, 255, 0.98); padding: 12px 12px calc(12px + env(safe-area-inset-bottom)); display: flex; gap: 10px; border-top: 2px solid #EEE; z-index: 1000; }
        #memoInput { flex: 1; padding: 12px 15px; border-radius: 15px; border: 2px solid #DDD; font-size: 16px; outline: none; resize: none; -webkit-appearance: none; background: #fff; line-height: 1.4; scrollbar-width: none; }
        #memoInput::-webkit-scrollbar { display: none; }
        .add-btn { background: var(--primary-color); color: white; border: none; padding: 0 24px; border-radius: 15px; font-weight: bold; font-size: 15px; }

        /* モーダル */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 85%; max-width: 320px; border-radius: 24px; padding: 25px; text-align: center; }
        .modal-btn { width: 100%; margin-bottom: 10px; padding: 14px; border-radius: 15px; border: 1px solid #EEE; background: #F9F9F9; font-weight: bold; color: #555; cursor: pointer; }
        .memo-controls { display: flex; gap: 8px; flex-shrink: 0; }
        .action-btn { border: none; background: rgba(255,255,255,0.8); font-size: 0.75rem; font-weight: bold; height: 38px; padding: 0 12px; border-radius: 10px; color: #333; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .btn-delete { background: #FFE5E5; color: #FF6B6B; display: none; }
        .memo-item.editing .btn-delete { display: block; }
        .memo-item.editing { flex-wrap: wrap; background: rgba(255,255,255,0.9) !important; border: 2px solid var(--primary-color); }
        .memo-item.editing .memo-body { display: block; -webkit-line-clamp: unset; flex-basis: 100%; margin: 10px 0; padding: 12px; background: #fff; border-radius: 10px; min-height: 100px; max-height: 300px; overflow-y: auto; text-shadow: none; }
        .drag-handle { cursor: grab; color: #333; font-size: 22px; display: none; padding: 10px 15px 10px 5px; touch-action: none; text-shadow: 0 0 8px #fff; }
        .memo-item.sort-mode .drag-handle { display: block; }
        .memo-item.sort-mode .memo-controls { display: none; }
    </style>
</head>
<body>

<div id="fixed-bg-layer"></div>

<div id="main-scroll-area">
    <div id="memoList"></div>
</div>

<div class="fixed-top" id="headerArea">
    <div class="header-main">
        <h1 class="app-title" id="displayTitle">カテゴリ 1</h1>
        <div class="header-icons">
            <button type="button" class="icon-btn" onclick="toggleSortMode()" id="sort-toggle-btn"><i class="fa-solid fa-sort"></i></button>
            <button type="button" class="icon-btn" onclick="openModal('dataModal')"><i class="fa-solid fa-floppy-disk"></i></button>
            <button type="button" class="icon-btn" onclick="openModal('bgModal')"><i class="fa-regular fa-image"></i></button>
        </div>
    </div>
    <div class="tab-grid" id="tabList"></div>
    <div class="search-container" style="padding: 0 10px 10px;">
        <input type="text" id="searchInput" placeholder="ひらめきを検索..." style="width:100%; padding:12px; border-radius:12px; border:2px solid #EEE; outline:none;">
    </div>
</div>

<div class="input-container" id="inputArea">
    <textarea id="memoInput" placeholder="なにか書く？" rows="1"></textarea>
    <button type="button" class="add-btn" onclick="addMemo()">追加</button>
</div>

<div id="bgModal" class="modal"><div class="modal-content"><h3 style="margin-top:0">デザイン設定</h3><button type="button" class="modal-btn" onclick="triggerBgPicker()">背景画像を選択</button><button type="button" class="modal-btn" onclick="adjustBgOffset()">上下位置を調整</button><button type="button" class="modal-btn" onclick="clearBg()">背景をリセット</button><button type="button" class="modal-btn" style="background:#F0F0F0; border:none; margin-top:10px" onclick="closeModal('bgModal')">とじる</button></div></div>
<div id="dataModal" class="modal"><div class="modal-content"><h3 style="margin-top:0">データ管理</h3><button type="button" class="modal-btn" onclick="exportData()">バックアップ (TXT)</button><button type="button" class="modal-btn" onclick="triggerImport()">データを復元</button><button type="button" class="modal-btn" style="background:#F0F0F0; border:none; margin-top:10px" onclick="closeModal('dataModal')">とじる</button></div></div>
<input type="file" id="bgPicker" accept="image/*" style="display:none"><input type="file" id="importPicker" accept=".txt,.json" style="display:none">

<script>
    'use strict';
    let currentTabIndex = 0; let isSortMode = false; let tabNames = []; let draggedElement = null;
    const Utils = {
        getStorage(key, def) { try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : def; } catch(e) { return def; } },
        setStorage(key, val) { try { localStorage.setItem(key, JSON.stringify(val)); return true; } catch(e) { alert("容量不足です。"); return false; } },
        formatDate(d) { return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; },
        genId() { return Date.now() + Math.random().toString(36).substr(2, 6); }
    };
    function init() {
        tabNames = Utils.getStorage('tab-names-v12', ["カテゴリ 1", "カテゴリ 2", "カテゴリ 3", "カテゴリ 4", "カテゴリ 5", "カテゴリ 6"]);
        const fixHeight = () => { document.getElementById('fixed-bg-layer').style.height = window.innerHeight + 'px'; };
        window.addEventListener('resize', fixHeight); fixHeight();
        renderTabs(); loadMemos(); applyBgImage(); setupEvents();
        setTimeout(adjustLayout, 300);
    }
    function setupEvents() {
        document.getElementById('bgPicker').onchange = handleBgSelect; document.getElementById('importPicker').onchange = handleFileImport;
        const input = document.getElementById('memoInput');
        input.oninput = function() { this.style.height = 'auto'; this.style.height = Math.min(this.scrollHeight, 120) + 'px'; adjustLayout(); };
        document.getElementById('searchInput').oninput = filterMemos; window.addEventListener('resize', adjustLayout);
        const scrollArea = document.getElementById('main-scroll-area');
        scrollArea.addEventListener('dragover', e => {
            if (!isSortMode || !draggedElement) return; e.preventDefault();
            const list = document.getElementById('memoList'); const afterElement = getDragAfterElement(list, e.clientY);
            if (afterElement == null) { list.appendChild(draggedElement); } else { list.insertBefore(draggedElement, afterElement); }
        });
    }
    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.memo-item:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } else { return closest; }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }
    function adjustLayout() {
        const header = document.getElementById('headerArea'); const scrollArea = document.getElementById('main-scroll-area'); const inputArea = document.getElementById('inputArea');
        if (header && scrollArea) { scrollArea.style.paddingTop = header.offsetHeight + 'px'; if (inputArea) { scrollArea.style.paddingBottom = (inputArea.offsetHeight + 40) + 'px'; } }
    }
    function renderMemo(m, targetList) {
        const div = document.createElement('div'); div.className = `memo-item ${isSortMode ? 'sort-mode' : ''}`; div.id = `m-${m.id}`; div.draggable = isSortMode;
        const safeText = m.text.replace(/</g,'&lt;');
        div.innerHTML = `
            <div class="drag-handle"><i class="fa-solid fa-bars"></i></div>
            <span class="date-text">${m.date}</span>
            <div class="memo-body">${safeText}</div>
            <div class="memo-controls">
                <button type="button" class="action-btn" onclick="copyText('${m.id}')">Copy</button>
                <button type="button" class="action-btn" onclick="toggleEdit('${m.id}')">編集</button>
                <button type="button" class="action-btn btn-delete" onclick="deleteMemo('${m.id}')">削除</button>
            </div>`;
        div.addEventListener('dragstart', () => { if (!isSortMode) return; draggedElement = div; setTimeout(() => div.classList.add('dragging'), 0); });
        div.addEventListener('dragend', () => { div.classList.remove('dragging'); draggedElement = null; saveOrder(); });
        targetList.appendChild(div);
    }
    function saveOrder() {
        const ids = [...document.querySelectorAll('.memo-item')].map(el => el.id.replace('m-',''));
        const oldData = Utils.getStorage(`memos-v12-t${currentTabIndex}`, []);
        const newData = ids.map(id => oldData.find(m => String(m.id) === String(id))).filter(Boolean);
        Utils.setStorage(`memos-v12-t${currentTabIndex}`, newData);
    }
    function applyBgImage() {
        const d = Utils.getStorage(`bg-v12-t${currentTabIndex}`, null); const offset = localStorage.getItem(`off-v12-t${currentTabIndex}`) || "0"; const bgLayer = document.getElementById('fixed-bg-layer');
        if (d) { bgLayer.style.display = 'block'; bgLayer.style.backgroundImage = `url("${d}")`; bgLayer.style.backgroundPosition = `center calc(50% + ${offset}px)`; } else { bgLayer.style.display = 'none'; }
    }
    function addMemo() {
        const input = document.getElementById('memoInput'); const text = input.value.trim(); if (!text) return;
        const data = Utils.getStorage(`memos-v12-t${currentTabIndex}`, []); data.unshift({ id: Utils.genId(), text, date: Utils.formatDate(new Date()) });
        if (Utils.setStorage(`memos-v12-t${currentTabIndex}`, data)) { input.value = ''; input.style.height = 'auto'; loadMemos(); document.getElementById('main-scroll-area').scrollTo({ top: 0, behavior: 'smooth' }); }
    }
    function loadMemos() {
        const list = document.getElementById('memoList'); list.innerHTML = ''; const data = Utils.getStorage(`memos-v12-t${currentTabIndex}`, []);
        if (!data.length) { list.innerHTML = `<div style="text-align:center; padding:80px 20px; color:#BBB; font-size:14px;">メモがありません</div>`; return; }
        data.forEach(m => renderMemo(m, list)); adjustLayout();
    }
    function toggleSortMode() { isSortMode = !isSortMode; const btn = document.getElementById('sort-toggle-btn'); btn.style.background = isSortMode ? 'var(--primary-color)' : '#fff'; btn.style.color = isSortMode ? '#fff' : '#666'; loadMemos(); }
    function renderTabs() { const list = document.getElementById('tabList'); list.innerHTML = ''; tabNames.forEach((name, i) => { const btn = document.createElement('div'); btn.className = `tab ${i === currentTabIndex ? 'active' : ''}`; btn.textContent = name; btn.onclick = () => { currentTabIndex = i; isSortMode = false; renderTabs(); applyBgImage(); loadMemos(); document.getElementById('main-scroll-area').scrollTo(0,0); }; btn.oncontextmenu = (e) => { e.preventDefault(); renameTab(i); }; list.appendChild(btn); }); document.getElementById('displayTitle').textContent = tabNames[currentTabIndex]; }
    function toggleEdit(id) { const el = document.getElementById(`m-${id}`); const body = el.querySelector('.memo-body'); const btn = el.querySelectorAll('.action-btn')[1]; if (!el.classList.contains('editing')) { el.classList.add('editing'); body.contentEditable = true; body.focus(); btn.textContent = "完了"; btn.style.background = "var(--primary-color)"; btn.style.color = "white"; } else { el.classList.remove('editing'); body.contentEditable = false; btn.textContent = "編集"; btn.style.background = "rgba(255,255,255,0.8)"; btn.style.color = "#333"; const data = Utils.getStorage(`memos-v12-t${currentTabIndex}`, []); const m = data.find(x => String(x.id) === String(id)); if (m) { m.text = body.innerText.trim(); Utils.setStorage(`memos-v12-t${currentTabIndex}`, data); } loadMemos(); } }
    function deleteMemo(id) { if (!confirm('削除しますか？')) return; let data = Utils.getStorage(`memos-v12-t${currentTabIndex}`, []); data = data.filter(m => String(m.id) !== String(id)); Utils.setStorage(`memos-v12-t${currentTabIndex}`, data); loadMemos(); }
    function copyText(id) { const data = Utils.getStorage(`memos-v12-t${currentTabIndex}`, []); const m = data.find(x => String(x.id) === String(id)); if (m) { navigator.clipboard.writeText(m.text).then(() => { const btn = document.querySelector(`#m-${id} .action-btn`); const original = btn.textContent; btn.textContent = "OK!"; setTimeout(() => btn.textContent = original, 1000); }); } }
    function renameTab(i) { const n = prompt("カテゴリ名変更:", tabNames[i]); if (n && n.trim()) { tabNames[i] = n.trim(); Utils.setStorage('tab-names-v12', tabNames); renderTabs(); } }
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function triggerBgPicker() { closeModal('bgModal'); document.getElementById('bgPicker').click(); }
    function triggerImport() { closeModal('dataModal'); document.getElementById('importPicker').click(); }
    function handleBgSelect(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (ev) => { const img = new Image(); img.onload = () => { const canvas = document.createElement('canvas'); let w = img.width, h = img.height, max = 1200; if (w > max || h > max) { if (w > h) { h = (h * max) / w; w = max; } else { w = (w * max) / h; h = max; } } canvas.width = w; canvas.height = h; canvas.getContext('2d').drawImage(img, 0, 0, w, h); const compressed = canvas.toDataURL('image/jpeg', 0.8); if (Utils.setStorage(`bg-v12-t${currentTabIndex}`, compressed)) { applyBgImage(); } }; img.src = ev.target.result; }; reader.readAsDataURL(file); }
    function clearBg() { localStorage.removeItem(`bg-v12-t${currentTabIndex}`); applyBgImage(); closeModal('bgModal'); }
    function adjustBgOffset() { const val = prompt("上下位置(px):", "0"); if (val !== null) { localStorage.setItem(`off-v12-t${currentTabIndex}`, val); applyBgImage(); } }
    function exportData() { const all = { version: "v12-util", tabs: tabNames, contents: {} }; for(let i=0; i<6; i++) all.contents[`tab_${i}`] = Utils.getStorage(`memos-v12-t${i}`, []); const blob = new Blob([JSON.stringify(all, null, 2)], { type: 'text/plain;charset=utf-8' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `memo_backup.txt`; a.click(); }
    function handleFileImport(e) { const f = e.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = (ev) => { try { const d = JSON.parse(ev.target.result); if (confirm("復元しますか？")) { Utils.setStorage('tab-names-v12', d.tabs || tabNames); for(let i=0; i<6; i++) Utils.setStorage(`memos-v12-t${i}`, d.contents ? d.contents[`tab_${i}`] : []); location.reload(); } } catch(e) { alert("不正なファイルです。"); } }; r.readAsText(f, 'UTF-8'); }
    function filterMemos() { const q = document.getElementById('searchInput').value.toLowerCase(); document.querySelectorAll('.memo-item').forEach(el => { el.style.display = el.innerText.toLowerCase().includes(q) ? 'flex' : 'none'; }); }
    init();
</script>
</body>
</html>
