<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Ë®òÊÜ∂„ÅÆÂΩºÊñπ</title>
    <link rel="manifest" href="./manifest.json">
    <style>
        :root {
            --primary-color: #A3D8FF; 
            --accent-color: #FFB3BA;  
            --edit-color: #BAFFC9;    
            --copy-color: #FFFFBA;    
            --bg-overlay: rgba(255, 255, 255, 0.9);
            --border-color: #888;
            --date-color: #666;
            --border-thick: 2px;
            --tab-1: #FFE4E6; --tab-2: #FFF1E0; --tab-3: #FEFFD6;
            --tab-4: #E6FFED; --tab-5: #E8F4FF; --tab-6: #F3E8FF;
        }

        * { box-sizing: border-box; }

        html, body { 
            height: 100%; 
            margin: 0; 
            padding: 0; 
            overscroll-behavior: none; /* „É™„É≠„Éº„Éâ„ÉªÊàª„ÇãÈò≤Ê≠¢ */
        }
        
        body {
            font-family: -apple-system, "Helvetica Neue", sans-serif;
            background-size: cover; 
            background-position: center 50%;
            background-attachment: fixed; 
            background-color: #f8f9fa;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        /* „Éò„ÉÉ„ÉÄ„ÉºË™øÊï¥ */
        .fixed-top {
            position: fixed; top: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(15px);
            z-index: 1000; border-bottom: var(--border-thick) solid var(--border-color);
            padding-top: env(safe-area-inset-top);
        }
        
        .header-main {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 12px; height: 50px;
        }
        .app-title { font-size: 19px; font-weight: 900; color: #333; margin: 0; }
        .header-icons { display: flex; gap: 8px; }
        
        .icon-btn { 
            background: white; border: var(--border-thick) solid var(--border-color);
            border-radius: 12px; width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; cursor: pointer; box-shadow: 2px 2px 0px var(--border-color);
        }

        .tab-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 6px 12px 10px; }
        .tab {
            padding: 10px 2px; border-radius: 12px; font-size: 0.95rem; 
            border: var(--border-thick) solid var(--border-color);
            text-align: center; font-weight: 800; cursor: pointer;
            box-shadow: 2px 2px 0px var(--border-color);
        }
        .tab:nth-child(1) { background: var(--tab-1); }
        .tab:nth-child(2) { background: var(--tab-2); }
        .tab:nth-child(3) { background: var(--tab-3); }
        .tab:nth-child(4) { background: var(--tab-4); }
        .tab:nth-child(5) { background: var(--tab-5); }
        .tab:nth-child(6) { background: var(--tab-6); }
        .tab.active { transform: translateY(-2px); box-shadow: 0px 4px 0px var(--border-color); filter: saturate(1.5); }

        .search-container { padding: 0 12px 12px; }
        #searchInput { 
            width: 100%; padding: 10px 15px; border-radius: 20px; 
            border: var(--border-thick) solid var(--border-color); outline: none;
        }

        /* „É°„É¢„Ç¢„Ç§„ÉÜ„É† */
        #memoList { padding-bottom: 180px; }
        .memo-item {
            display: flex; align-items: center; margin: 10px 12px; padding: 12px;
            border: var(--border-thick) solid var(--border-color);
            border-radius: 16px; gap: 10px; background: var(--bg-overlay);
            backdrop-filter: blur(5px);
        }
        .memo-body { 
            flex: 1; font-size: 0.95rem; color: #222; 
            white-space: pre-wrap; word-break: break-all;
        }

        .memo-controls { display: flex; gap: 6px; }
        .action-btn { 
            border: var(--border-thick) solid var(--border-color); background: white; 
            font-size: 0.75rem; font-weight: 800; padding: 8px; border-radius: 10px;
        }

        /* ÂÖ•Âäõ„Ç®„É™„Ç¢‰øÆÊ≠£ */
        .input-container {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.98); 
            padding: 12px 14px calc(15px + env(safe-area-inset-bottom));
            display: flex; gap: 10px; border-top: var(--border-thick) solid var(--border-color); z-index: 1000;
        }
        #memoInput { 
            flex: 1; padding: 12px; border-radius: 15px; border: var(--border-thick) solid var(--border-color);
            font-size: 16px; outline: none; resize: none; max-height: 120px;
            overflow: hidden; /* Âè≥Á´Ø„ÅÆÁ∑ö„ÇíÈò≤Ê≠¢ */
        }
        .add-btn { 
            background: var(--primary-color); border: var(--border-thick) solid var(--border-color); 
            padding: 0 20px; border-radius: 15px; font-weight: 900; box-shadow: 2px 2px 0px var(--border-color);
        }

        /* „É¢„Éº„ÉÄ„É´ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 85%; max-width: 320px; border: var(--border-thick) solid var(--border-color); border-radius: 25px; padding: 25px; }
        .modal-btn { width: 100%; margin-bottom: 12px; padding: 12px; border-radius: 15px; border: var(--border-thick) solid var(--border-color); font-weight: bold; background: white; }
    </style>
</head>
<body>

<div class="fixed-top" id="headerArea">
    <div class="header-main">
        <h1 class="app-title" id="displayTitle">Ë®òÊÜ∂„ÅÆÂΩºÊñπ</h1>
        <div class="header-icons">
            <button type="button" class="icon-btn" onclick="toggleSortMode()">‚áÖ</button>
            <button type="button" class="icon-btn" onclick="openModal('dataModal')">üíæ</button>
            <button type="button" class="icon-btn" onclick="openModal('bgModal')">üñºÔ∏è</button>
        </div>
    </div>
    <div class="tab-grid" id="tabList"></div>
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Ê§úÁ¥¢...">
    </div>
</div>

<div id="memoList"></div>

<div class="input-container">
    <textarea id="memoInput" placeholder="ÂÖ•Âäõ..." rows="1"></textarea>
    <button type="button" class="add-btn" onclick="addMemo()">ËøΩÂä†</button>
</div>

<div id="bgModal" class="modal">
    <div class="modal-content">
        <button type="button" class="modal-btn" onclick="triggerBgPicker()">üì∑ ÁîªÂÉè„ÇíÈÅ∏Êäû</button>
        <button type="button" class="modal-btn" onclick="clearBg()">üóëÔ∏è ÂâäÈô§</button>
        <button type="button" class="modal-btn" onclick="closeModal('bgModal')">Êàª„Çã</button>
    </div>
</div>

<div id="dataModal" class="modal">
    <div class="modal-content">
        <button type="button" class="modal-btn" onclick="exportData()">üì§ TXT‰øùÂ≠ò</button>
        <button type="button" class="modal-btn" onclick="triggerImport()">üì• Âæ©ÂÖÉ</button>
        <button type="button" class="modal-btn" onclick="closeModal('dataModal')">Êàª„Çã</button>
    </div>
</div>

<input type="file" id="bgPicker" accept="image/*" style="display:none">
<input type="file" id="importPicker" accept=".txt,.json" style="display:none">

<script>
    'use strict';
    let currentTabIndex = 0;
    let isSortMode = false;
    let tabNames = [];

    const Utils = {
        getStorage(key, def) { try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : def; } catch(e) { return def; } },
        setStorage(key, val) { try { localStorage.setItem(key, JSON.stringify(val)); return true; } catch(e) { alert("ÂÆπÈáè‰∏çË∂≥„Åß„Åô"); return false; } },
        formatDate(d) { return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`; }
    };

    function init() {
        tabNames = Utils.getStorage('tab-names-v11', ["„Ç´„ÉÜ„Ç¥„É™ 1", "„Ç´„ÉÜ„Ç¥„É™ 2", "„Ç´„ÉÜ„Ç¥„É™ 3", "„Ç´„ÉÜ„Ç¥„É™ 4", "„Ç´„ÉÜ„Ç¥„É™ 5", "„Ç´„ÉÜ„Ç¥„É™ 6"]);
        renderTabs();
        loadMemos();
        applyBgImage();
        
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(console.error);
        }

        // ÂÖ•ÂäõÊ¨Ñ„ÅÆËá™Âãï‰º∏Èï∑
        const input = document.getElementById('memoInput');
        input.addEventListener('input', () => {
            input.style.height = 'auto';
            input.style.height = input.scrollHeight + 'px';
        });

        window.addEventListener('resize', adjustLayout);
        setTimeout(adjustLayout, 300);
    }

    function renderTabs() {
        const list = document.getElementById('tabList');
        list.innerHTML = '';
        tabNames.forEach((name, i) => {
            const btn = document.createElement('div');
            btn.className = `tab ${i === currentTabIndex ? 'active' : ''}`;
            btn.innerText = name;
            btn.onclick = () => { currentTabIndex = i; renderTabs(); applyBgImage(); loadMemos(); adjustLayout(); };
            list.appendChild(btn);
        });
        document.getElementById('displayTitle').innerText = tabNames[currentTabIndex];
    }

    function loadMemos() {
        const list = document.getElementById('memoList');
        list.innerHTML = '';
        const data = Utils.getStorage(`memos-v11-t${currentTabIndex}`, []);
        data.forEach(m => {
            const div = document.createElement('div');
            div.className = 'memo-item';
            div.innerHTML = `
                <div class="memo-body"></div>
                <div class="memo-controls">
                    <button type="button" class="action-btn" onclick="deleteMemo('${m.id}')">Ê∂àÂéª</button>
                </div>
            `;
            div.querySelector('.memo-body').innerText = m.text; // innerText„Çí‰ΩøÁî®
            list.appendChild(div);
        });
    }

    function addMemo() {
        const input = document.getElementById('memoInput');
        if (!input.value.trim()) return;
        const data = Utils.getStorage(`memos-v11-t${currentTabIndex}`, []);
        data.unshift({ id: Date.now().toString(), text: input.value, date: Utils.formatDate(new Date()) });
        Utils.setStorage(`memos-v11-t${currentTabIndex}`, data);
        input.value = '';
        input.style.height = 'auto';
        loadMemos();
    }

    function deleteMemo(id) {
        if (!confirm('ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
        let data = Utils.getStorage(`memos-v11-t${currentTabIndex}`, []);
        data = data.filter(m => m.id !== id);
        Utils.setStorage(`memos-v11-t${currentTabIndex}`, data);
        loadMemos();
    }

    function exportData() {
        const all = { version: "v11-full", contents: {} };
        for(let i=0; i<6; i++) all.contents[`tab_${i}`] = Utils.getStorage(`memos-v11-t${i}`, []);
        const blob = new Blob([JSON.stringify(all)], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        
        // <a>„Çø„Ç∞Á¶ÅÊ≠¢„ÅÆ„Åü„ÇÅ„ÄÅwindow.open „Åæ„Åü„ÅØ location.href „ÅßÂØæÂøú
        window.open(url, '_blank');
        setTimeout(() => URL.revokeObjectURL(url), 1000);
    }

    function applyBgImage() {
        const d = Utils.getStorage(`bg-v11-t${currentTabIndex}`, null);
        document.body.style.backgroundImage = d ? `url("${d}")` : "none";
    }

    function adjustLayout() {
        const h = document.getElementById('headerArea').offsetHeight;
        document.body.style.paddingTop = (h + 10) + 'px';
    }

    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function triggerBgPicker() { document.getElementById('bgPicker').click(); closeModal('bgModal'); }
    function triggerImport() { document.getElementById('importPicker').click(); closeModal('dataModal'); }

    init();
</script>
</body>
</html>
