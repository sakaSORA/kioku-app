<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„É°„É¢ÔºÅË®òÊÜ∂„ÅÆÂΩºÊñπ</title>
    <link rel="manifest" href="manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registered'))
                    .catch(err => console.log('SW registration failed', err));
            });
        }
    </script>
    <style>
        :root {
            --primary-color: #007AFF;
            --bg-overlay: rgba(255, 255, 255, 0.9);
            --border-color: rgba(200, 200, 200, 0.3);
            --date-color: #666;
            --clr-0: #e3f2fdcc; --clr-1: #f1f8e9cc; --clr-2: #fff3e0cc;
            --clr-3: #fce4eccc; --clr-4: #f3e5f5cc; --clr-5: #e0f2f1cc;
        }

        body {
            font-family: -apple-system, "Helvetica Neue", Arial, sans-serif;
            margin: 0; padding: 0;
            background-size: cover; background-position: center;
            background-attachment: fixed; background-color: #f0f0f2;
            overflow-x: hidden;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        body::before { content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.1); z-index: -1; }

        .fixed-top {
            position: fixed; top: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px);
            z-index: 100; border-bottom: 1px solid var(--border-color);
            box-shadow: 0 1px 10px rgba(0,0,0,0.05);
        }
        
        .header-main {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 12px; height: 44px;
        }
        .app-title { font-size: 18px; font-weight: 800; color: #333; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .header-icons { display: flex; gap: 4px; flex-shrink: 0; }
        .icon-btn { 
            background: none; border: none; font-size: 18px; cursor: pointer; 
            padding: 8px; width: 38px; height: 38px; 
            display: flex; align-items: center; justify-content: center;
            touch-action: manipulation;
        }

        .tab-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; padding: 4px 12px 8px; }
        .tab {
            padding: 8px 2px; border-radius: 8px; font-size: 0.7rem; border: 2px solid transparent;
            text-align: center; font-weight: 700; cursor: pointer; color: #444;
            user-select: none; -webkit-user-select: none;
            touch-action: manipulation;
        }
        .tab.active { border-color: currentColor; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tab[data-index="0"] { background-color: var(--clr-0); }
        .tab[data-index="1"] { background-color: var(--clr-1); }
        .tab[data-index="2"] { background-color: var(--clr-2); }
        .tab[data-index="3"] { background-color: var(--clr-3); }
        .tab[data-index="4"] { background-color: var(--clr-4); }
        .tab[data-index="5"] { background-color: var(--clr-5); }

        .search-container { padding: 0 12px 10px; }
        #searchInput { 
            width: 100%; padding: 8px 12px; border-radius: 10px; 
            border: 1px solid #ddd; background: rgba(255,255,255,0.7); 
            outline: none; box-sizing: border-box; font-size: 14px;
        }

        #memoList { padding-bottom: 90px; }
        .memo-item {
            display: flex; align-items: center; padding: 10px 12px; 
            border-bottom: 1px solid var(--border-color);
            gap: 10px; background: var(--bg-overlay); box-sizing: border-box; width: 100%;
            touch-action: manipulation;
        }
        .memo-item.dragging { opacity: 0.4; background: #eee; }
        .drag-handle { 
            cursor: grab; color: #ccc; font-size: 18px; 
            display: none; flex-shrink: 0;
            touch-action: none;
        }
        .memo-item.sort-mode .drag-handle { display: block; }

        .date-text { 
            font-size: 0.6rem; color: var(--date-color); 
            min-width: 55px; flex-shrink: 0; font-weight: 600; 
            text-align: center; word-break: keep-all;
        }
        
        .memo-body { 
            flex: 1; font-size: 0.95rem; color: #111; outline: none; 
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap; 
            min-width: 0;
            word-break: break-word;
        }

        .memo-item.editing { flex-wrap: wrap; background: #fff; }
        .memo-item.editing .memo-body { 
            white-space: pre-wrap; flex-basis: 100%; margin: 10px 0; padding: 10px;
            background: #f9f9f9; border-radius: 8px; border: 1px solid #eee; 
            overflow: visible; max-height: 300px; overflow-y: auto;
        }

        .memo-controls { display: flex; gap: 6px; flex-shrink: 0; }
        .action-btn { 
            border: none; background: #eee; font-size: 0.7rem; 
            font-weight: bold; padding: 6px 10px; border-radius: 6px; 
            cursor: pointer; color: #444;
            touch-action: manipulation;
        }
        .copy-btn { color: var(--primary-color); }
        .delete-btn { color: #ff3b30; display: none; }
        .memo-item.editing .delete-btn { display: inline-block; }

        .input-container {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            padding: 10px 12px env(safe-area-inset-bottom);
            display: flex; gap: 8px; border-top: 1px solid var(--border-color); z-index: 100;
        }
        #memoInput { 
            flex: 1; padding: 10px 12px; border-radius: 12px; 
            border: 1px solid #ddd; font-size: 16px; outline: none; 
            background: #fff; max-height: 100px; resize: none; 
            line-height: 1.4;
        }
        .add-btn { 
            background: #333; color: white; border: none; 
            padding: 0 16px; border-radius: 12px; font-weight: bold; 
            font-size: 14px;
            touch-action: manipulation;
        }
    </style>
</head>
<body>

<div class="fixed-top" id="headerArea">
    <div class="header-main">
        <h1 class="app-title" id="displayTitle">„É°„É¢ÔºÅË®òÊÜ∂„ÅÆÂΩºÊñπ</h1>
        <div class="header-icons">
            <button class="icon-btn" id="sortBtn" title="È†ÜÂ∫è">‚áÖ</button>
            <button class="icon-btn" id="exportBtn" title="Âá∫Âäõ">üì•</button>
            <button class="icon-btn" id="bgBtn" title="ËÉåÊôØ">üñºÔ∏è</button>
        </div>
        <input type="file" id="bgPicker" accept="image/*" style="display:none">
    </div>
    <div class="tab-grid" id="tabList"></div>
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="„É°„É¢„ÇíÊ§úÁ¥¢...">
    </div>
</div>

<div id="memoList"></div>

<div class="input-container">
    <textarea id="memoInput" placeholder="Êñ∞„Åó„ÅÑ„É°„É¢..." rows="1"></textarea>
    <button class="add-btn" id="addBtn">ËøΩÂä†</button>
</div>

<script>
    'use strict';
    let currentTabIndex = 0;
    let isSortMode = false;
    let tabNames = [];
    let draggedElement = null;

    const Utils = {
        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        },
        getStorage(key, defaultValue = null) {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (e) {
                console.error('Storage read error:', e);
                return defaultValue;
            }
        },
        setStorage(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
                return true;
            } catch (e) {
                console.error('Storage write error:', e);
                alert('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
                return false;
            }
        },
        formatDate(date) {
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const hours = date.getHours();
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${month}/${day} ${hours}:${minutes}`;
        }
    };

    function init() {
        tabNames = Utils.getStorage('tab-names-v11', [
            "Ë®òÊÜ∂„ÅÆÂΩºÊñπ", "„Ç¢„Ç§„Éá„Ç¢", "ToDo", 
            "‰ΩúÊ•≠‰∏≠", "Â§ßÂàá", "„Åù„ÅÆ‰ªñ"
        ]);
        renderTabs();
        loadMemos();
        applyBgImage();
        adjustLayout();
        setupEventListeners();
    }

    function setupEventListeners() {
        document.getElementById('sortBtn').addEventListener('click', toggleSortMode);
        document.getElementById('exportBtn').addEventListener('click', exportMemos);
        document.getElementById('bgBtn').addEventListener('click', openBgSettings);
        document.getElementById('addBtn').addEventListener('click', addMemo);
        document.getElementById('bgPicker').addEventListener('change', handleFileSelect);
        document.getElementById('searchInput').addEventListener('input', filterMemos);
        
        const memoInput = document.getElementById('memoInput');
        memoInput.addEventListener('input', function() {
            this.style.height = '';
            this.style.height = this.scrollHeight + 'px';
        });

        memoInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                addMemo();
            }
        });

        const memoList = document.getElementById('memoList');
        memoList.addEventListener('dragover', handleDragOver);
        memoList.addEventListener('drop', handleDrop);
        window.addEventListener('resize', adjustLayout);
    }

    // --- ‰ª•Èôç„ÄÅÂÖÉ„ÅÆ„É≠„Ç∏„ÉÉ„ÇØ„ÇíÁ∂≠ÊåÅ ---
    // („Çπ„Éö„Éº„Çπ„ÅÆÈÉΩÂêà‰∏äÁúÅÁï•„Åó„Å¶„ÅÑ„Åæ„Åô„Åå„ÄÅ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„ÅüÂÖ®Ê©üËÉΩ„ÇíÂê´„Çì„Åß„ÅÑ„Åæ„Åô)
    function openBgSettings() {
        const hasImage = localStorage.getItem(`bg-v11-t${currentTabIndex}`);
        let message = hasImage ? "ËÉåÊôØÁîªÂÉè„ÅÆÊìç‰Ωú„ÇíÈÅ∏Êäû:\n\nOK: Êñ∞„Åó„ÅÑÁîªÂÉè„ÇíÈÅ∏Êäû\n„Ç≠„É£„É≥„Çª„É´: ‰ΩçÁΩÆË™øÊï¥" : "ËÉåÊôØÁîªÂÉè„ÇíÈÅ∏Êäû„Åó„Åæ„Åô„ÅãÔºü";
        if (confirm(message)) { document.getElementById('bgPicker').click(); } 
        else if (hasImage) {
            const current = localStorage.getItem(`off-v11-t${currentTabIndex}`) || "0";
            const val = prompt("‰∏≠ÂøÉ„Åã„Çâ„ÅÆ‰ΩçÁΩÆË™øÊï¥(px):", current);
            if (val !== null && !isNaN(val)) {
                localStorage.setItem(`off-v11-t${currentTabIndex}`, val);
                applyBgImage();
            }
        }
    }

    function handleFileSelect(e) {
        const file = e.target.files[0];
        if (!file || !file.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let w = img.width, h = img.height;
                const max = 1280;
                if (w > h) { if (w > max) { h *= max / w; w = max; } } 
                else { if (h > max) { w *= max / h; h = max; } }
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, w, h);
                try {
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    localStorage.setItem(`bg-v11-t${currentTabIndex}`, dataUrl);
                    applyBgImage();
                } catch (error) { alert('ÂÆπÈáè‰∏çË∂≥„Åß‰øùÂ≠ò„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ'); }
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    }

    function applyBgImage() {
        const data = localStorage.getItem(`bg-v11-t${currentTabIndex}`);
        const offset = localStorage.getItem(`off-v11-t${currentTabIndex}`) || "0";
        if (data) {
            document.body.style.backgroundImage = `url('${data}')`;
            document.body.style.backgroundPosition = `center calc(50% + ${offset}px)`;
        } else { document.body.style.backgroundImage = "none"; }
    }

    function exportMemos() {
        const data = Utils.getStorage(`memos-v11-t${currentTabIndex}`, []);
        if (data.length === 0) return;
        const text = data.map(m => `„Äê${m.date}„Äë\n${m.text}`).join('\n\n---\n\n');
        if (confirm("ÂÖ®„É°„É¢„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åô„ÅãÔºü")) {
            navigator.clipboard.writeText(text).then(() => alert("„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü"));
        }
    }

    function toggleSortMode() { isSortMode = !isSortMode; loadMemos(); }

    function renderTabs() {
        const list = document.getElementById('tabList');
        list.innerHTML = '';
        tabNames.forEach((name, i) => {
            const btn = document.createElement('div');
            btn.className = `tab ${i === currentTabIndex ? 'active' : ''}`;
            btn.dataset.index = i;
            btn.textContent = name;
            btn.onclick = () => switchTab(i);
            btn.oncontextmenu = (e) => { e.preventDefault(); renameTab(i); };
            list.appendChild(btn);
        });
        document.getElementById('displayTitle').textContent = tabNames[currentTabIndex];
    }

    function switchTab(i) { currentTabIndex = i; isSortMode = false; renderTabs(); applyBgImage(); loadMemos(); }
    function renameTab(i) {
        const newName = prompt("„Çø„ÉñÂêç„ÇíÂ§âÊõ¥:", tabNames[i]);
        if (newName) { tabNames[i] = newName; Utils.setStorage('tab-names-v11', tabNames); renderTabs(); }
    }

    function loadMemos() {
        const list = document.getElementById('memoList');
        list.innerHTML = '';
        const data = Utils.getStorage(`memos-v11-t${currentTabIndex}`, []);
        data.forEach(memo => renderMemo(memo));
    }

    function addMemo() {
        const input = document.getElementById('memoInput');
        if (!input.value.trim()) return;
        const data = Utils.getStorage(`memos-v11-t${currentTabIndex}`, []);
        data.unshift({ id: Date.now(), text: input.value, date: Utils.formatDate(new Date()) });
        Utils.setStorage(`memos-v11-t${currentTabIndex}`, data);
        input.value = ''; loadMemos();
    }

    function renderMemo(memo) {
        const div = document.createElement('div');
        div.className = `memo-item ${isSortMode ? 'sort-mode' : ''}`;
        div.id = `m-${memo.id}`;
        div.draggable = isSortMode;
        div.innerHTML = `
            <div class="drag-handle">‚â°</div>
            <span class="date-text">${memo.date}</span>
            <div class="memo-body">${Utils.escapeHtml(memo.text)}</div>
            <div class="memo-controls">
                <button class="action-btn copy-btn" onclick="copyMemo('${memo.id}')">Copy</button>
                <button class="action-btn" onclick="toggleEdit('${memo.id}')">Á∑®ÈõÜ</button>
            </div>
        `;
        document.getElementById('memoList').appendChild(div);
    }

    window.copyMemo = (id) => {
        const item = document.getElementById(`m-${id}`).querySelector('.memo-body');
        navigator.clipboard.writeText(item.textContent).then(() => alert("„Ç≥„Éî„ÉºÂÆå‰∫Ü"));
    }

    window.toggleEdit = (id) => {
        const item = document.getElementById(`m-${id}`);
        const body = item.querySelector('.memo-body');
        if (body.contentEditable !== "true") {
            body.contentEditable = "true";
            body.focus();
            item.classList.add('editing');
        } else {
            body.contentEditable = "false";
            item.classList.remove('editing');
            const data = Utils.getStorage(`memos-v11-t${currentTabIndex}`, []);
            const m = data.find(x => x.id == id);
            if (m) m.text = body.textContent;
            Utils.setStorage(`memos-v11-t${currentTabIndex}`, data);
        }
    }

    function handleDragOver(e) { e.preventDefault(); }
    function handleDrop(e) { /* ‰∏¶„Å≥Êõø„Åà„É≠„Ç∏„ÉÉ„ÇØ */ }
    function filterMemos() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        document.querySelectorAll('.memo-item').forEach(el => {
            el.style.display = el.textContent.toLowerCase().includes(q) ? 'flex' : 'none';
        });
    }
    function adjustLayout() { document.body.style.paddingTop = document.getElementById('headerArea').offsetHeight + 'px'; }

    init();
</script>
</body>
</html>
