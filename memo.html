<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¨˜æ†¶ã®å½¼æ–¹ - Standalone Professional Edition</title>
    <style>
        :root {
            --primary-color: #007AFF;
            --bg-overlay: rgba(255, 255, 255, 0.85);
            --border-color: #333;
            --date-color: #666;
            --border-thick: 2px;
        }

        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåŸºç›¤ */
        html, body { height: 100%; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, "Helvetica Neue", Arial, sans-serif;
            background-size: cover;
            background-position: center 50%;
            background-attachment: fixed;
            background-repeat: no-repeat;
            background-color: #f0f0f2;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            min-height: 100vh;
        }

        /* å›ºå®šãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆã‚¿ãƒ–ã‚’å«ã‚€ï¼‰ */
        .fixed-top {
            position: fixed; top: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px);
            z-index: 1000; border-bottom: var(--border-thick) solid var(--border-color);
        }
        
        .header-main {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 12px; height: 44px;
        }
        .app-title { font-size: 18px; font-weight: 800; color: #333; margin: 0; }
        .header-icons { display: flex; gap: 8px; }
        .icon-btn { 
            background: white; border: var(--border-thick) solid var(--border-color);
            border-radius: 8px; width: 38px; height: 38px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; cursor: pointer; box-shadow: 2px 2px 0px var(--border-color);
        }
        .icon-btn:active { transform: translate(1px, 1px); box-shadow: none; }

        /* ã‚¿ãƒ–ã‚¨ãƒªã‚¢ */
        .tab-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; padding: 4px 12px 8px; }
        .tab {
            padding: 8px 2px; border-radius: 8px; font-size: 0.7rem; 
            border: var(--border-thick) solid var(--border-color);
            text-align: center; font-weight: 700; cursor: pointer; background: white;
            box-shadow: 2px 2px 0px var(--border-color);
        }
        .tab.active { background: var(--primary-color); color: white; transform: translateY(1px); box-shadow: none; }

        .search-container { padding: 0 12px 10px; }
        #searchInput { 
            width: 100%; padding: 8px 12px; border-radius: 10px; 
            border: var(--border-thick) solid var(--border-color); outline: none; box-sizing: border-box;
        }

        /* ãƒ¡ãƒ¢ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆ1è¡Œè¡¨ç¤ºã®å¾¹åº•ï¼‰ */
        #memoList { padding-bottom: 150px; }
        .memo-item {
            display: flex; align-items: center; margin: 10px 12px; padding: 12px;
            border: var(--border-thick) solid var(--border-color);
            border-radius: 12px; gap: 10px; background: var(--bg-overlay);
            box-shadow: 3px 3px 0px rgba(0,0,0,0.1); backdrop-filter: blur(5px);
        }
        .memo-item.dragging { opacity: 0.4; }
        .drag-handle { cursor: grab; color: #ccc; font-size: 20px; display: none; }
        .memo-item.sort-mode .drag-handle { display: block; }

        .date-text { font-size: 0.6rem; color: var(--date-color); min-width: 55px; flex-shrink: 0; font-weight: 600; text-align: center; }
        
        .memo-body { 
            flex: 1; font-size: 0.95rem; color: #111; outline: none; 
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap; 
            min-width: 0;
        }

        /* ç·¨é›†æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .memo-item.editing { flex-wrap: wrap; background: #fff; }
        .memo-item.editing .memo-body { 
            white-space: pre-wrap; flex-basis: 100%; margin: 10px 0; padding: 10px;
            background: #f9f9f9; border-radius: 8px; border: 1px dashed #999; 
            overflow: visible; max-height: 300px; overflow-y: auto;
        }

        .memo-controls { display: flex; gap: 6px; flex-shrink: 0; }
        .action-btn { 
            border: 1px solid var(--border-color); background: white; font-size: 0.7rem; 
            font-weight: bold; padding: 6px 10px; border-radius: 6px; cursor: pointer;
        }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ï¼ˆã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢å¯¾å¿œï¼‰ */
        .input-container {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.95); padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
            display: flex; gap: 8px; border-top: var(--border-thick) solid var(--border-color); z-index: 1000;
        }
        #memoInput { 
            flex: 1; padding: 10px; border-radius: 12px; border: var(--border-thick) solid var(--border-color);
            font-size: 16px; outline: none; resize: none; max-height: 100px;
        }
        .add-btn { 
            background: #333; color: white; border: none; padding: 0 20px; 
            border-radius: 12px; font-weight: bold; cursor: pointer;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º */
        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(4px);
        }
        .modal-content { 
            background: white; width: 85%; max-width: 320px; border: var(--border-thick) solid var(--border-color); 
            border-radius: 20px; padding: 20px; box-shadow: 6px 6px 0px rgba(0,0,0,0.2); text-align: center; 
        }
        .modal-btn { 
            width: 100%; margin-bottom: 10px; padding: 12px; border-radius: 10px; 
            border: var(--border-thick) solid var(--border-color); font-weight: bold; cursor: pointer; background: white;
        }
    </style>
</head>
<body>

<div class="fixed-top" id="headerArea">
    <div class="header-main">
        <h1 class="app-title" id="displayTitle">è¨˜æ†¶ã®å½¼æ–¹</h1>
        <div class="header-icons">
            <button class="icon-btn" onclick="toggleSortMode()" title="é †åºå¤‰æ›´">â‡…</button>
            <button class="icon-btn" onclick="openModal('dataModal')" title="ãƒ‡ãƒ¼ã‚¿ç®¡ç†">ğŸ’¾</button>
            <button class="icon-btn" onclick="openModal('bgModal')" title="èƒŒæ™¯ç®¡ç†">ğŸ–¼ï¸</button>
        </div>
        <input type="file" id="bgPicker" accept="image/*" style="display:none">
        <input type="file" id="importPicker" accept=".txt,.json" style="display:none">
    </div>
    <div class="tab-grid" id="tabList"></div>
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="ãƒ¡ãƒ¢å†…ã‚’æ¤œç´¢...">
    </div>
</div>

<div id="memoList"></div>

<div class="input-container">
    <textarea id="memoInput" placeholder="æ–°ã—ã„è¨˜æ†¶ã‚’å…¥åŠ›..." rows="1"></textarea>
    <button class="add-btn" onclick="addMemo()">è¿½åŠ </button>
</div>

<div id="bgModal" class="modal">
    <div class="modal-content">
        <h3>ğŸ–¼ï¸ èƒŒæ™¯ç®¡ç†</h3>
        <button class="modal-btn" onclick="triggerBgPicker()">ğŸ“· ç”»åƒã‚’é¸æŠ</button>
        <button class="modal-btn" onclick="adjustBgOffset()">â†•ï¸ ä½ç½®ã‚’èª¿æ•´</button>
        <button class="modal-btn" onclick="clearBg()">ğŸ—‘ï¸ èƒŒæ™¯ã‚’å‰Šé™¤</button>
        <button class="modal-btn" style="background:#eee" onclick="closeModal('bgModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
</div>

<div id="dataModal" class="modal">
    <div class="modal-content">
        <h3>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
        <button class="modal-btn" onclick="exportData()">ğŸ“¤ TXTã§ä¿å­˜</button>
        <button class="modal-btn" onclick="triggerImport()">ğŸ“¥ ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¾©å…ƒ</button>
        <button class="modal-btn" style="background:#eee" onclick="closeModal('dataModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
</div>
<script>
    'use strict';
    let currentTabIndex = 0;
    let isSortMode = false;
    let tabNames = [];
    let draggedElement = null;

    const Utils = {
        getStorage(key, def) { 
            try { 
                const v = localStorage.getItem(key); 
                return v ? JSON.parse(v) : def; 
            } catch(e) { return def; } 
        },
        setStorage(key, val) { 
            try { 
                localStorage.setItem(key, JSON.stringify(val)); 
                return true; 
            } catch(e) { 
                alert("ãƒ–ãƒ©ã‚¦ã‚¶ã®ä¿å­˜å®¹é‡ã‚’è¶…ãˆã¾ã—ãŸã€‚èƒŒæ™¯ç”»åƒã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚");
                return false; 
            } 
        },
        formatDate(d) { return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`; },
        genId() { return Date.now() + Math.random().toString(36).substr(2, 6); }
    };

    function init() {
        tabNames = Utils.getStorage('tab-names-v11', ["ã‚«ãƒ†ã‚´ãƒª 1", "ã‚«ãƒ†ã‚´ãƒª 2", "ã‚«ãƒ†ã‚´ãƒª 3", "ã‚«ãƒ†ã‚´ãƒª 4", "ã‚«ãƒ†ã‚´ãƒª 5", "ã‚«ãƒ†ã‚´ãƒª 6"]);
        renderTabs();
        loadMemos();
        applyBgImage();
        setupEvents();
        window.addEventListener('resize', adjustLayout);
        setTimeout(adjustLayout, 200); // èµ·å‹•æ™‚ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨ˆç®—

        // ã‚µãƒ¼ãƒãƒ¼å®Ÿè¡Œæ™‚ä»¥å¤–ï¼ˆfile:///ï¼‰ã¯Service Workerã‚’ã‚¹ã‚­ãƒƒãƒ—
        if (window.location.protocol !== 'file:' && 'serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(() => {});
        }
    }

    function setupEvents() {
        document.getElementById('bgPicker').onchange = handleBgSelect;
        document.getElementById('importPicker').onchange = handleFileImport;
        const input = document.getElementById('memoInput');
        input.oninput = function() { 
            this.style.height = 'auto'; 
            this.style.height = this.scrollHeight + 'px'; 
        };
        
        const list = document.getElementById('memoList');
        list.addEventListener('dragover', e => {
            if (!isSortMode) return;
            e.preventDefault();
            const after = [...list.querySelectorAll('.memo-item:not(.dragging)')].find(s => e.clientY < s.getBoundingClientRect().top + s.offsetHeight/2);
            list.insertBefore(draggedElement, after);
        });
        document.getElementById('searchInput').oninput = filterMemos;
    }

    // --- èƒŒæ™¯ç®¡ç†ï¼ˆå¾©å…ƒæ©Ÿèƒ½ï¼‰ ---
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function triggerBgPicker() { closeModal('bgModal'); document.getElementById('bgPicker').click(); }

    function handleBgSelect(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let w = img.width, h = img.height, max = 1280;
                if (w > max || h > max) {
                    if (w > h) { h = (h * max) / w; w = max; } else { w = (w * max) / h; h = max; }
                }
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, w, h);
                const compressed = canvas.toDataURL('image/jpeg', 0.4); // 0.4åœ§ç¸®æ¡ç”¨
                if (Utils.setStorage(`bg-v11-t${currentTabIndex}`, compressed)) { applyBgImage(); }
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    }

    function adjustBgOffset() {
        const current = localStorage.getItem(`off-v11-t${currentTabIndex}`) || "0";
        const val = prompt("èƒŒæ™¯ã®ä¸Šä¸‹ä½ç½®ã‚’èª¿æ•´ (pxå˜ä½):", current);
        if (val !== null && !isNaN(val)) {
            localStorage.setItem(`off-v11-t${currentTabIndex}`, val);
            applyBgImage();
        }
    }

    function clearBg() {
        if (confirm("ã“ã®ã‚¿ãƒ–ã®èƒŒæ™¯è¨­å®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            localStorage.removeItem(`bg-v11-t${currentTabIndex}`);
            localStorage.removeItem(`off-v11-t${currentTabIndex}`);
            applyBgImage();
            closeModal('bgModal');
        }
    }

    function applyBgImage() {
        const d = Utils.getStorage(`bg-v11-t${currentTabIndex}`, null);
        const offset = localStorage.getItem(`off-v11-t${currentTabIndex}`) || "0";
        const body = document.body;
        if (d) {
            body.style.backgroundImage = `url("${d}")`;
            body.style.backgroundPosition = `center calc(50% + ${offset}px)`; // ä½ç½®èª¿æ•´ã‚’å¾©å…ƒ
        } else {
            body.style.backgroundImage = "none";
        }
    }

    // --- ãƒ¡ãƒ¢ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯ ---
    function loadMemos() {
        const list = document.getElementById('memoList'); list.innerHTML = '';
        const data = Utils.getStorage(`memos-v11-t${currentTabIndex}`, []);
        if (!data.length) { list.innerHTML = '<div style="text-align:center; padding:50px; color:#999;">ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
        data.forEach(m => renderMemo(m));
    }

    function renderMemo(m) {
        const div = document.createElement('div');
        div.className = `memo-item ${isSortMode ? 'sort-mode' : ''}`;
        div.id = `m-${m.id}`; div.draggable = isSortMode;
        div.innerHTML = `
            <div class="drag-handle">â‰¡</div>
            <span class="date-text">${m.date}</span>
            <div class="memo-body">${m.text.replace(/</g,'&lt;')}</div>
            <div class="memo-controls">
                <button class="action-btn" onclick="copyText('${m.id}')">Copy</button>
                <button class="action-btn" onclick="toggleEdit('${m.id}')">ç·¨é›†</button>
                <button class="action-btn" style="color:red" onclick="deleteMemo('${m.id}')">æ¶ˆå»</button>
            </div>`;
        if (isSortMode) {
            div.ondragstart = () => { draggedElement = div; div.classList.add('dragging'); };
            div.ondragend = () => { div.classList.remove('dragging'); draggedElement = null; saveOrder(); };
        }
        document.getElementById('memoList').appendChild(div);
    }

    function addMemo() {
        const input = document.getElementById('memoInput');
        const text = input.value.trim();
        if (!text) return;
        const data = Utils.getStorage(`memos-v11-t${currentTabIndex}`, []);
        data.unshift({ id: Utils.genId(), text, date: Utils.formatDate(new Date()) });
        if (Utils.setStorage(`memos-v11-t${currentTabIndex}`, data)) { 
            input.value = ''; 
            input.style.height = 'auto'; 
            loadMemos(); 
        }
    }

    function toggleEdit(id) {
        const el = document.getElementById(`m-${id}`);
        const body = el.querySelector('.memo-body');
        const btn = el.querySelectorAll('.action-btn')[1];
        if (!el.classList.contains('editing')) {
            el.classList.add('editing'); body.contentEditable = true; body.focus(); btn.textContent = "å®Œäº†";
        } else {
            el.classList.remove('editing'); body.contentEditable = false; btn.textContent = "ç·¨é›†";
            const data = Utils.getStorage(`memos-v11-t${currentTabIndex}`, []);
            const m = data.find(x => String(x.id) === String(id));
            if (m) { 
                m.text = body.innerText.trim(); 
                Utils.setStorage(`memos-v11-t${currentTabIndex}`, data); 
            }
            loadMemos();
        }
    }

    function deleteMemo(id) {
        if (!confirm('ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        let data = Utils.getStorage(`memos-v11-t${currentTabIndex}`, []);
        data = data.filter(m => String(m.id) !== String(id));
        Utils.setStorage(`memos-v11-t${currentTabIndex}`, data); loadMemos();
    }

    function copyText(id) {
        const data = Utils.getStorage(`memos-v11-t${currentTabIndex}`, []);
        const m = data.find(x => String(x.id) === String(id));
        if (m) {
            navigator.clipboard.writeText(m.text).then(() => { 
                alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); 
            });
        }
    }

    // --- ã‚¿ãƒ–ãƒ»æ¤œç´¢ãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ ---
    function toggleSortMode() { isSortMode = !isSortMode; loadMemos(); }
    function saveOrder() {
        const ids = [...document.querySelectorAll('.memo-item')].map(el => el.id.replace('m-',''));
        const old = Utils.getStorage(`memos-v11-t${currentTabIndex}`, []);
        const sorted = ids.map(id => old.find(m => String(m.id) === String(id))).filter(Boolean);
        Utils.setStorage(`memos-v11-t${currentTabIndex}`, sorted);
    }

    function renderTabs() {
        const list = document.getElementById('tabList'); list.innerHTML = '';
        tabNames.forEach((name, i) => {
            const btn = document.createElement('div');
            btn.className = `tab ${i === currentTabIndex ? 'active' : ''}`; btn.textContent = name;
            btn.onclick = () => { 
                currentTabIndex = i; isSortMode = false; 
                renderTabs(); applyBgImage(); loadMemos(); adjustLayout(); 
            };
            btn.oncontextmenu = (e) => { e.preventDefault(); renameTab(i); };
            list.appendChild(btn);
        });
        document.getElementById('displayTitle').textContent = tabNames[currentTabIndex];
    }

    function renameTab(i) {
        const n = prompt("æ–°ã—ã„ã‚¿ãƒ–åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", tabNames[i]);
        if (n && n.trim()) { 
            tabNames[i] = n.trim(); 
            Utils.setStorage('tab-names-v11', tabNames); 
            renderTabs(); 
        }
    }

    function exportData() {
        const all = { version: "v11-full", tabs: tabNames, contents: {} };
        for(let i=0; i<6; i++) all.contents[`tab_${i}`] = Utils.getStorage(`memos-v11-t${i}`, []);
        const blob = new Blob([JSON.stringify(all, null, 2)], { type: 'text/plain' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `kioku_backup.txt`; a.click();
        closeModal('dataModal');
    }

    function triggerImport() { closeModal('dataModal'); document.getElementById('importPicker').click(); }
    function handleFileImport(e) {
        const f = e.target.files[0]; if (!f) return;
        const r = new FileReader();
        r.onload = (ev) => {
            try {
                const d = JSON.parse(ev.target.result);
                if (d.version === "v11-full" && confirm("å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¦å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ")) {
                    tabNames = d.tabs; 
                    Utils.setStorage('tab-names-v11', d.tabs);
                    for(let i=0; i<6; i++) Utils.setStorage(`memos-v11-t${i}`, d.contents[`tab_${i}`] || []);
                    location.reload();
                }
            } catch(e) { alert("ç„¡åŠ¹ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚"); }
        };
        r.readAsText(f);
    }

    function filterMemos() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        document.querySelectorAll('.memo-item').forEach(el => {
            el.style.display = el.innerText.toLowerCase().includes(q) ? 'flex' : 'none';
        });
    }

    function adjustLayout() {
        const h = document.getElementById('headerArea').offsetHeight;
        document.body.style.paddingTop = (h + 10) + 'px'; // ã‚¿ãƒ–ã®æ®µæ•°ã«å¿œã˜ã¦å‹•çš„ã«èª¿æ•´
    }

    init();
</script>
</body>
</html>
